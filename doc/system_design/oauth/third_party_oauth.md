# サードパーティを使用したOAuth認証の流れ

1. ユーザーは認証ページをリクエストする。
1. Frontendサーバーは認証ページをユーザーに返す。
1. ユーザーはTwitter認証ボタンをクリックする。
  * フロントページのJSがAPIサーバーにTwitter OAuth認証のGETを送信する。
1. APIサーバーはTwitterサーバーにoauth/request_tokenを要求する
1. Twitterサーバーはoauth_tokenをAPIサーバーに返す。
1. APIサーバーはステータスコードを302とし、https://api.twitter.com/oauth/authenticate?oauth_token= にリダイレクトするようにユーザーにレスポンスする。
1. フロントのJSは受け取ったレスポンスコードが302であることを確認し、指定されたURLにリダイレクトさせる。
1. Twitterサーバーはユーザーに認証ページを表示
1. ユーザーはTwitterを認証
1. Twitterサーバーはユーザーに認可ページを表示
1. ユーザーは認可を了承
1. Twitterサーバーは予め登録されていたコールバックURLにリダイレクトさせるように、ユーザーへResponseを返す。
1. ブラウザはコールバックURLにリダイレクトする。(このコールバックURLをフロントサーバーのドメインにし、パラメータをそのまま付けておく)
1. フロントのJSは、APIサーバーのTwitter認可APIをGETで即座に呼び出す
1. APIサーバーは与えられたコードからTwitterサーバーにアクセストークンを要求する
1. TwitterサーバーはアクセストークンをAPIサーバーに返す。
1. APIサーバーはTwitterのアクセストークンを使用し、Twitterのアカウント情報を元にユーザーを作成する。
1. APIサーバーは、作成したユーザー用のアクセストークンを作成する。
1. APIサーバーは、アクセストークンをユーザーに返す。
1. フロントはアクセストークンを保持する。
